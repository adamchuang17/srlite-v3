<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>SimpleReceiveLite v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body { font-family: "Microsoft JhengHei", system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #f3f4f6; margin: 0; }
    header { background: #1f2937; color: white; padding: 10px; text-align: center; }
    .container { padding: 20px; }
    label { margin-right:6px }
    select, input { padding:6px 8px; margin-right:8px }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; background:#fff }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; }
    th { background: #f8fafc; }
    button { margin: 2px; padding: 6px 10px; border:0; border-radius:6px; background:#334155; color:#fff; cursor:pointer }
    button.primary{ background:#22c55e; }
    button.warn{ background:#ef4444; }
    #modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); justify-content:center; align-items:center; padding:16px; }
    #modal .content { background:white; color:#0f172a; padding:20px; border-radius:10px; max-width:560px; width:100%; }
    canvas { border:1px solid #e5e7eb; display:block; margin:10px auto; background:#0b1220; width:100%; height:220px }
    .actions { text-align:center; margin-top:10px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap }
    footer{ text-align:center; color:#64748b; font-size:12px; margin:14px 0 }
    @media print{ header, .container > div:first-child, footer { display:none } }
  </style>
</head>
<body>
  <header>
    <h1>SimpleReceiveLite v4</h1>
    <div style="font-size:13px;opacity:.8">ä¸‰æ¬„ä½å€ â†’ å¾…ç°½æ”¶ â†’ ç°½æ”¶ï¼ˆç°½åï¼‰ â†’ åˆ—å°/åŒ¯å‡ºï¼›æµæ°´è™Ÿ 1â€“500 å¾ªç’°</div>
  </header>

  <div class="container">
    <!-- æ–°å¢å€ -->
    <div>
      <label>æ£Ÿåˆ¥ï¼š</label>
      <select id="building"></select>
      <label>æ¨“å±¤ï¼š</label>
      <select id="floor"></select>
      <label>æˆ¶è™Ÿï¼š</label>
      <select id="unit"></select>
      <label>è²¨é‹å…¬å¸ï¼š</label>
      <select id="shipper">
        <option value="">è«‹é¸æ“‡</option>
        <option>å¤§æ¦®</option><option>æ–°ç«¹</option><option>å®…é…é€š</option><option>å®…æ€¥ä¾¿</option><option>å…¶ä»–</option>
      </select>
      <input type="text" id="customShipper" placeholder="å…¶ä»–è²¨é‹å…¬å¸" style="display:none;">
      <label>æ”¶è²¨äººï¼š</label>
      <input type="text" id="receiver" placeholder="æ”¶è²¨äººå§“å">
      <label>æ•¸é‡ï¼š</label>
      <input type="number" id="qty" value="1" min="1" style="width:80px">
      <button class="primary" onclick="addRecord()">æ–°å¢</button>
    </div>

    <!-- æœå°‹ -->
    <div style="margin-top:10px;">
      <label>æœå°‹ï¼š</label>
      <input type="text" id="searchBox" placeholder="å¯è¼¸å…¥ä½å€æˆ–æ”¶è²¨äºº">
      <button onclick="search()">æœå°‹</button>
      <button onclick="resetSearch()">é‡ç½®</button>
    </div>

    <!-- å¾…ç°½æ”¶è¡¨ -->
    <table id="recordTable">
      <thead>
        <tr>
          <th>æµæ°´è™Ÿ</th><th>ä½å€</th><th>è²¨é‹å…¬å¸</th><th>æ”¶è²¨äºº</th><th>æ•¸é‡</th><th>æ”¶è²¨æ™‚é–“</th><th>å‹•ä½œ</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- ç°½å Modal -->
  <div id="modal">
    <div class="content">
      <h3 id="signInfo" style="margin:0 0 8px"></h3>
      <canvas id="sig" width="880" height="220"></canvas>
      <div class="actions">
        <input type="text" id="signer" placeholder="ç°½æ”¶äºº" />
        <input type="number" id="signQty" min="1" value="1" style="width:100px" />
        <button id="downloadSig">ä¸‹è¼‰ç°½åï¼ˆPNGï¼‰</button>
        <button id="clearSig">æ¸…é™¤ç°½å</button>
        <button class="warn" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="primary" id="saveSig">ç¢ºèªç°½æ”¶ â†’ åˆ—å°/å­˜PDF</button>
      </div>
    </div>
  </div>

  <footer id="ver"></footer>

<script>
/* ===== åŸºæœ¬å·¥å…· ===== */
const $ = id => document.getElementById(id);
const nowISO = ()=> {
  const d=new Date(); const p=n=>String(n).padStart(2,'0');
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
};

/* ===== å…ƒä»¶ ===== */
const buildingEl = $('building'), floorEl = $('floor'), unitEl = $('unit');
const shipperEl = $('shipper'), customShipperEl = $('customShipper');
const receiverEl = $('receiver'), qtyEl = $('qty');
const tableBody = $('recordTable').querySelector('tbody');
const searchBox = $('searchBox');
const modal = $('modal'), signInfo = $('signInfo'), sig = $('sig'), signerEl = $('signer'), signQtyEl = $('signQty');
const ctx = sig.getContext('2d');
let isDrawing=false, last=null;
let records = JSON.parse(localStorage.getItem('records')||'[]');
let currentSerial=null, currentHeader='';
let serialCounter = parseInt(localStorage.getItem('serialCounter')||'1');

/* ===== åˆå§‹åŒ–ä¸‹æ‹‰ ===== */
const buildings = ['ç”²','ä¹™','ä¸™','ä¸','æˆŠ','å·±'];
function initSelects(){
  buildings.forEach(b=>{ let o=new Option(b,b); buildingEl.add(o); });
  for(let i=1;i<=14;i++) floorEl.add(new Option(i+'æ¨“', i+'æ¨“'));
  for(let i=1;i<=8;i++)  unitEl.add(new Option('ä¹‹'+i, 'ä¹‹'+i));
}
initSelects();

/* è²¨é‹å…¬å¸ã€Œå…¶ä»–ã€ */
shipperEl.onchange=()=>{ customShipperEl.style.display = (shipperEl.value==='å…¶ä»–')?'inline':'none'; };

/* ===== æ–°å¢è¨˜éŒ„ ===== */
function addRecord(){
  const b=buildingEl.value, f=floorEl.value, u=unitEl.value;
  if(!b||!f||!u) return alert('è«‹é¸æ“‡å®Œæ•´ä½å€');
  const addr = `${b} ${f}${u}`;
  const shipper = shipperEl.value==='å…¶ä»–'? (customShipperEl.value||'å…¶ä»–'): (shipperEl.value||'');
  const rec = {
    serial: serialCounter,
    address: addr,
    shipper,
    receiver: receiverEl.value.trim(),
    qty: Math.max(1, parseInt(qtyEl.value||'1',10)),
    created_at: nowISO(),
    signed:false, signer:'', signed_at:'', signData:''
  };
  records.push(rec);
  serialCounter = serialCounter>=500?1:serialCounter+1;
  persist();
  render();
  receiverEl.value=''; qtyEl.value=1;
}
function persist(){
  localStorage.setItem('records', JSON.stringify(records));
  localStorage.setItem('serialCounter', serialCounter);
}

/* ===== ç¹ªè¡¨ï¼ˆåªé¡¯ç¤ºæœªç°½æ”¶ï¼‰===== */
function render(list=records){
  tableBody.innerHTML='';
  list.filter(r=>!r.signed).forEach(rec=>{
    const tr=document.createElement('tr');
    const openBtn = `<button onclick='openSign(${rec.serial})'>ç°½æ”¶</button>`;
    tr.innerHTML = `
      <td>${rec.serial}</td>
      <td>${rec.address}</td>
      <td>${rec.shipper||''}</td>
      <td>${rec.receiver||''}</td>
      <td>${rec.qty}</td>
      <td>${rec.created_at||''}</td>
      <td>${openBtn}</td>`;
    tableBody.appendChild(tr);
  });
}

/* ===== æœå°‹ ===== */
function search(){
  const kw=searchBox.value.trim(); if(!kw) return render();
  const list = records.filter(r => (!r.signed) && ((r.address||'').includes(kw) || (r.receiver||'').includes(kw)));
  render(list);
}
function resetSearch(){ searchBox.value=''; render(); }

/* ===== ç°½åæ¿ ===== */
function resetCanvas(headerText){
  // èƒŒæ™¯
  ctx.fillStyle="#0b1220"; ctx.fillRect(0,0,sig.width,sig.height);
  // æŠ¬é ­
  if(headerText){
    ctx.fillStyle="#94a3b8";
    ctx.font="16px 'Microsoft JhengHei', system-ui, -apple-system, Segoe UI, Roboto, sans-serif";
    const pad=14, maxW=sig.width-pad*2, lineH=22; let line='', y=24;
    for(const ch of headerText){
      const test=line+ch;
      if(ctx.measureText(test).width>maxW && line){
        ctx.fillText(line,pad,y); line=ch; y+=lineH;
      }else line=test;
    }
    if(line) ctx.fillText(line,pad,y);
  }
  // ç­†è·¡
  ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=3; ctx.lineCap='round';
}

/* ä¸‹è¼‰ç°½å PNG */
$('downloadSig').onclick = ()=>{
  const link=document.createElement('a');
  link.href=sig.toDataURL('image/png');
  link.download=`signature_${currentSerial}.png`;
  link.click();
};

/* ç°½åäº‹ä»¶ */
sig.addEventListener('mousedown',e=>{ isDrawing=true; last={x:e.offsetX,y:e.offsetY}; });
sig.addEventListener('mousemove',e=>{
  if(!isDrawing) return;
  ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(e.offsetX,e.offsetY); ctx.stroke();
  last={x:e.offsetX,y:e.offsetY};
});
['mouseup','mouseleave'].forEach(ev=> sig.addEventListener(ev, ()=> isDrawing=false ));
$('clearSig').onclick = ()=> resetCanvas(currentHeader);

/* ===== é–‹å•Ÿç°½åè¦–çª— ===== */
function openSign(serial){
  const rec = records.find(r=>r.serial===serial && !r.signed);
  if(!rec) return;
  currentSerial = serial;
  currentHeader = `ä½å€ï¼š${rec.address} ï½œ æµæ°´è™Ÿï¼š${serial}`;
  signerEl.value=''; signQtyEl.value=rec.qty||1;
  resetCanvas(currentHeader);
  signInfo.textContent = `æµæ°´è™Ÿï¼š${serial}ï½œä½å€ï¼š${rec.address}`;
  modal.style.display='flex';
}
function closeModal(){ modal.style.display='none'; }

/* ===== ç”¢ç”Ÿã€Œç°½æ”¶å–®ã€æ–°è¦–çª—ï¼ˆå¯åˆ—å°/å­˜PDFï¼‰ ===== */
function openReceiptWindow(rec){
  const w = window.open('', '_blank');
  const safe = s=>String(s||'');
  const html = `
  <!doctype html><html lang="zh-Hant"><head><meta charset="utf-8">
  <title>ç°½æ”¶å–® #${safe(rec.serial)}</title>
  <style>
    body{font-family:"Microsoft JhengHei",sans-serif;margin:24px;color:#111827}
    h2{margin:0 0 8px}
    .meta{color:#374151;margin-bottom:12px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #9ca3af;padding:8px;text-align:left}
    th{background:#f3f4f6}
    .sig{margin-top:16px}
    img{max-width:100%;height:auto;border:1px solid #e5e7eb}
    @media print{ button{display:none} }
  </style>
  </head><body>
    <h2>ç°½æ”¶å–®ï¼ˆReceiptï¼‰</h2>
    <div class="meta">åˆ—å°æ™‚é–“ï¼š${nowISO()}</div>
    <table>
      <tr><th>æµæ°´è™Ÿ</th><td>${safe(rec.serial)}</td></tr>
      <tr><th>ä½å€</th><td>${safe(rec.address)}</td></tr>
      <tr><th>æ”¶è²¨äºº</th><td>${safe(rec.receiver)}</td></tr>
      <tr><th>è²¨é‹å…¬å¸</th><td>${safe(rec.shipper)}</td></tr>
      <tr><th>æ•¸é‡</th><td>${safe(rec.qty)}</td></tr>
      <tr><th>æ”¶è²¨æ™‚é–“</th><td>${safe(rec.created_at)}</td></tr>
      <tr><th>ç°½æ”¶äºº</th><td>${safe(rec.signer)}</td></tr>
      <tr><th>ç°½æ”¶æ™‚é–“</th><td>${safe(rec.signed_at)}</td></tr>
    </table>
    <div class="sig">
      <div style="margin:8px 0 6px">ç°½åï¼ˆSignatureï¼‰</div>
      ${rec.signData ? `<img src="${rec.signData}" alt="signature">` : 'â€”'}
    </div>
    <div style="margin-top:16px">
      <button onclick="window.print()">ğŸ–¨ ç«‹å³åˆ—å° / å­˜æˆ PDF</button>
    </div>
  </body></html>`;
  w.document.open(); w.document.write(html); w.document.close();
}

/* ===== ç¢ºèªç°½æ”¶ â†’ å­˜æª” â†’ é–‹å•Ÿåˆ—å°è¦–çª— ===== */
$('saveSig').onclick = ()=>{
  const rec = records.find(r=>r.serial===currentSerial && !r.signed);
  if(!rec) return;
  if(!signerEl.value.trim()) return alert('è«‹è¼¸å…¥ç°½æ”¶äºº');
  rec.signed = true;
  rec.signer = signerEl.value.trim();
  rec.qty = Math.max(1, parseInt(signQtyEl.value||rec.qty,10));
  rec.signData = sig.toDataURL('image/png');
  rec.signed_at = nowISO();
  persist();
  closeModal();
  render();
  // æ‰“é–‹å¯åˆ—å°çš„ç°½æ”¶å–®ï¼ˆä½¿ç”¨è€…å¯ç›´æ¥åˆ—å°æˆ–é¸æ“‡ã€Œå¦å­˜ç‚º PDFã€ï¼‰
  openReceiptWindow(rec);
};

/* ===== ç‰ˆæœ¬é¡¯ç¤º ===== */
(function(){
  $('ver').textContent = `SimpleReceiveLite v4.2 ï½œ æœ€å¾Œæ›´æ–°ï¼š${new Date().toLocaleString()}`;
})();

/* ===== é¦–æ¬¡æ¸²æŸ“ ===== */
render();
</script>
</body>
</html>
