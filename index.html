<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>SimpleReceiveLite v3</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; color:#0f172a }
    h1 { color: #2c3e50; margin-bottom:8px }
    label { display: block; margin-top: 10px; }
    select, input { padding: 6px 8px; margin-top: 5px; width: 220px; }
    button { margin-top: 12px; padding: 8px 14px; border:0; border-radius:6px; background:#22c55e; color:#fff; cursor:pointer }
    button.secondary { background:#0ea5e9 }
    button.warn { background:#ef4444 }
    table { border-collapse: collapse; margin-top: 18px; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size:14px }
    th { background: #f8fafc; }
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .tip{color:#64748b; font-size:12px}
  </style>
</head>
<body>
  <h1>📦 SimpleReceiveLite v3</h1>
  <div class="tip">（已內建 住址搜尋 + CSV 匯出：今日 / 全部）</div>

  <form id="receiveForm">
    <label>棟別：
      <select id="building" required>
        <option value="">請選擇</option>
        <option value="47">甲棟 (47)</option>
        <option value="47-7">乙棟 (47-7)</option>
        <option value="47-6">丙棟 (47-6)</option>
        <option value="47-5">丁棟 (47-5)</option>
        <option value="47-3">戊棟 (47-3)</option>
        <option value="47-1">己棟 (47-1)</option>
      </select>
    </label>

    <label>樓層：
      <select id="floor" required></select>
    </label>

    <label>戶號：
      <select id="unit" required></select>
    </label>

    <label>貨件類型：
      <select id="type" required>
        <option value="">請選擇</option>
        <option value="包裹">包裹</option>
        <option value="掛號">掛號</option>
      </select>
    </label>

    <label>收件人：
      <input id="receiver" required placeholder="住戶姓名" />
    </label>

    <label>件數：
      <input id="count" type="number" min="1" value="1" required />
    </label>

    <label>貨運公司：
      <input id="company" list="companyList" placeholder="選或輸入" />
      <datalist id="companyList">
        <option value="大榮">
        <option value="新竹">
        <option value="宅配通">
        <option value="宅急便">
        <option value="其他">
      </datalist>
    </label>

    <label>備註：
      <input id="note" placeholder="擺放位置或備註" />
    </label>

    <button type="submit">新增紀錄</button>
    <span id="status" class="tip"></span>
  </form>

  <div class="toolbar">
    <button id="searchBtn" class="secondary">依住址搜尋</button>
    <button id="exportToday" class="secondary">下載今日紀錄 (CSV)</button>
    <button id="exportAll" class="secondary">下載全部紀錄 (CSV)</button>
    <button id="clearAll" class="warn" title="僅清除本機保存的表格資料">清空紀錄</button>
  </div>

  <table id="recordTable">
    <thead>
      <tr>
        <th>時間</th>
        <th>流水號</th>
        <th>棟別</th>
        <th>樓層</th>
        <th>戶號</th>
        <th>貨件類型</th>
        <th>收件人</th>
        <th>件數</th>
        <th>貨運公司</th>
        <th>備註</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const form = document.getElementById("receiveForm");
    const tableBody = document.querySelector("#recordTable tbody");
    const buildingSel = document.getElementById("building");
    const floorSel = document.getElementById("floor");
    const unitSel = document.getElementById("unit");

    let records = JSON.parse(localStorage.getItem("records") || "[]");
    let counter = records.length ? (records[records.length-1].id % 500)+1 : 1;

    // 初始化樓層、戶號
    function populateFloors() {
      floorSel.innerHTML = '<option value="">請選擇</option>';
      for(let i=1;i<=14;i++) floorSel.innerHTML += `<option value="${i}樓">${i}樓</option>`;
    }
    function populateUnits() {
      unitSel.innerHTML = '<option value="">請選擇</option>';
      for(let i=1;i<=8;i++) unitSel.innerHTML += `<option value="之${i}">之${i}</option>`;
    }
    populateFloors(); populateUnits();

    // 渲染表格
    function render(data=records) {
      tableBody.innerHTML="";
      data.forEach(r=>{
        let row=tableBody.insertRow();
        row.insertCell().textContent=r.time;
        row.insertCell().textContent=r.id;
        row.insertCell().textContent=r.building;
        row.insertCell().textContent=r.floor;
        row.insertCell().textContent=r.unit;
        row.insertCell().textContent=r.type;
        row.insertCell().textContent=r.receiver;
        row.insertCell().textContent=r.count;
        row.insertCell().textContent=r.company;
        row.insertCell().textContent=r.note;
      });
      localStorage.setItem("records",JSON.stringify(records));
    }
    render();

    // 新增紀錄
    form.addEventListener("submit",e=>{
      e.preventDefault();
      const now=new Date();
      const rec={
        id:counter,
        time:now.toLocaleString(),
        building:buildingSel.value,
        floor:floorSel.value,
        unit:unitSel.value,
        type:document.getElementById("type").value,
        receiver:document.getElementById("receiver").value,
        count:document.getElementById("count").value,
        company:document.getElementById("company").value,
        note:document.getElementById("note").value
      };
      if(records.length>=500) records.shift(); // 超過500刪最舊
      records.push(rec);
      counter = counter%500+1;
      render();
      form.reset();
    });

    // 匯出 CSV
    function exportCSV(data,filename){
      let csv="時間,流水號,棟別,樓層,戶號,貨件類型,收件人,件數,貨運公司,備註\n";
      data.forEach(r=> csv+=[r.time,r.id,r.building,r.floor,r.unit,r.type,r.receiver,r.count,r.company,r.note].join(",")+"\n");
      let blob=new Blob([csv],{type:"text/csv"});
      let url=URL.createObjectURL(blob);
      let a=document.createElement("a"); a.href=url; a.download=filename; a.click();
      URL.revokeObjectURL(url);
    }
    document.getElementById("exportToday").onclick=()=>{
      const today=new Date().toLocaleDateString();
      exportCSV(records.filter(r=>r.time.startsWith(today)),"today.csv");
    };
    document.getElementById("exportAll").onclick=()=>exportCSV(records,"all.csv");

    // 依住址搜尋
    document.getElementById("searchBtn").onclick=()=>{
      const b=buildingSel.value,f=floorSel.value,u=unitSel.value;
      render(records.filter(r=>r.building===b && r.floor===f && r.unit===u));
    };

    // 清空
    document.getElementById("clearAll").onclick=()=>{
      if(confirm("確定清除所有紀錄？")){records=[];counter=1;render();}
    };
  </script>
</body>
</html>
