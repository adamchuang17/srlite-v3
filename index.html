<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>SimpleReceiveLite v4 â€” é€£å‹•ä¸‹æ‹‰</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; color:#0f172a }
    h1 { color: #2c3e50; margin-bottom:8px }
    label { display:block; margin-top:10px }
    select, input { padding:6px 8px; margin-top:5px; width:220px }
    button { margin-top:12px; padding:8px 14px; border:0; border-radius:6px; background:#22c55e; color:#fff; cursor:pointer }
    button.secondary { background:#0ea5e9 }
    button.warn { background:#ef4444 }
    button.ghost { background:#334155 }
    table { border-collapse:collapse; margin-top:18px; width:100% }
    th,td { border:1px solid #e5e7eb; padding:8px; text-align:center; font-size:14px }
    th { background:#f8fafc }
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-top:10px}
    .tip{color:#64748b; font-size:12px}
    .group{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .muted{color:#64748b}
    .disabled { opacity:.6 }
  </style>
</head>
<body>
  <h1>ğŸ“¦ SimpleReceiveLite v4</h1>
  <div class="tip">æ”¶è²¨ç™»éŒ„ï¼‹ä¸‰æ¬„é€£å‹•ç¯©é¸ï¼ˆæ£Ÿ â†’ æ¨“ â†’ æˆ¶ï¼‰ã€‚å«ã€Œä»Šæ—¥ / å…¨éƒ¨ã€CSV åŒ¯å‡ºã€‚</div>

  <!-- æ”¶è²¨è¡¨å–®ï¼ˆé€£å‹•ï¼‰ -->
  <form id="receiveForm">
    <label>æ£Ÿåˆ¥ï¼š
      <select id="building" required></select>
    </label>

    <label>æ¨“å±¤ï¼š
      <select id="floor" required disabled></select>
    </label>

    <label>æˆ¶è™Ÿï¼š
      <select id="unit" required disabled></select>
    </label>

    <label>è²¨ä»¶é¡å‹ï¼š
      <select id="type" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="åŒ…è£¹">åŒ…è£¹</option>
        <option value="æ›è™Ÿ">æ›è™Ÿ</option>
      </select>
    </label>

    <label>æ”¶ä»¶äººï¼š
      <input id="receiver" required placeholder="ä½æˆ¶å§“å" />
    </label>

    <label>ä»¶æ•¸ï¼š
      <input id="count" type="number" min="1" value="1" required />
    </label>

    <label>è²¨é‹å…¬å¸ï¼š
      <input id="company" list="companyList" placeholder="å¤§æ¦® / æ–°ç«¹ / å®…é…é€š / å®…æ€¥ä¾¿ / å…¶ä»–" />
      <datalist id="companyList">
        <option value="å¤§æ¦®"><option value="æ–°ç«¹"><option value="å®…é…é€š"><option value="å®…æ€¥ä¾¿"><option value="å…¶ä»–">
      </datalist>
    </label>

    <label>å‚™è¨»ï¼š
      <input id="note" placeholder="æ“ºæ”¾ä½ç½®æˆ–å‚™è¨»" />
    </label>

    <button type="submit">æ–°å¢ç´€éŒ„</button>
    <span id="status" class="tip"></span>
  </form>

  <!-- ä¸‰æ¬„ã€Œé€£å‹•ã€ç¯©é¸ï¼ˆåˆ—è¡¨ï¼‰ -->
  <div class="toolbar">
    <div class="group">
      <span class="muted">ç¯©é¸ï¼š</span>
      <select id="bldF" title="æ£Ÿåˆ¥"></select>
      <select id="floorF" title="æ¨“å±¤" disabled></select>
      <select id="unitF" title="æˆ¶è™Ÿ" disabled></select>
      <button id="resetFilters" class="ghost" type="button">æ¸…é™¤ç¯©é¸</button>
    </div>
    <div class="group">
      <button id="exportToday" class="secondary" type="button">ä¸‹è¼‰ä»Šæ—¥ç´€éŒ„ (CSV)</button>
      <button id="exportAll" class="secondary" type="button">ä¸‹è¼‰å…¨éƒ¨ç´€éŒ„ (CSV)</button>
      <button id="clearAll" class="warn" type="button" title="åƒ…æ¸…é™¤æœ¬æ©Ÿä¿å­˜çš„è¡¨æ ¼è³‡æ–™">æ¸…ç©ºç´€éŒ„</button>
    </div>
  </div>

  <!-- ç´€éŒ„è¡¨æ ¼ -->
  <table id="recordTable">
    <thead>
      <tr>
        <th>æ™‚é–“</th>
        <th>æµæ°´è™Ÿ</th>
        <th>æ£Ÿåˆ¥</th>
        <th>æ¨“å±¤</th>
        <th>æˆ¶è™Ÿ</th>
        <th>è²¨ä»¶é¡å‹</th>
        <th>æ”¶ä»¶äºº</th>
        <th>ä»¶æ•¸</th>
        <th>è²¨é‹å…¬å¸</th>
        <th>å‚™è¨»</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  // ================== å¸¸æ•¸ ==================
  const BUILDINGS = ["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±"];      // é¡¯ç¤ºç”¨
  const FLOORS = Array.from({length:14},(_,i)=> (i+1)+"æ¨“");
  const UNITS  = Array.from({length:8}, (_,i)=> "ä¹‹"+(i+1));

  // ================== å…ƒä»¶ ==================
  const form = document.getElementById("receiveForm");
  const tableBody = document.querySelector("#recordTable tbody");
  const status = document.getElementById("status");

  const buildingSel = document.getElementById("building");
  const floorSel    = document.getElementById("floor");
  const unitSel     = document.getElementById("unit");

  const bldF   = document.getElementById("bldF");
  const floorF = document.getElementById("floorF");
  const unitF  = document.getElementById("unitF");
  const resetFiltersBtn = document.getElementById("resetFilters");

  // ================== è³‡æ–™å„²å­˜ ==================
  let records = load();
  let counter = records.length ? Math.max(...records.map(r=>r.id))+1 : 1;

  function load(){
    try { return JSON.parse(localStorage.getItem("records") || "[]"); }
    catch { return []; }
  }
  function save(){ localStorage.setItem("records", JSON.stringify(records)); }

  // ================== å·¥å…· ==================
  function fill(select, arr, {withAll=false, placeholder="è«‹é¸æ“‡"} = {}){
    select.innerHTML = "";
    if (withAll){
      const opt = document.createElement("option");
      opt.value = ""; opt.textContent = "å…¨éƒ¨";
      select.appendChild(opt);
    } else {
      const opt0 = document.createElement("option");
      opt0.value = ""; opt0.textContent = placeholder;
      select.appendChild(opt0);
    }
    arr.forEach(v=>{
      const o=document.createElement("option");
      o.value=v; o.textContent=v;
      select.appendChild(o);
    });
  }
  function todayKey(d=new Date()){
    const pad=n=>String(n).padStart(2,"0");
    return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  }

  // ================== è¡¨å–®ï¼šé€£å‹•ä¸‹æ‹‰ ==================
  function initFormSelectors(){
    fill(buildingSel, BUILDINGS, {withAll:false, placeholder:"è«‹é¸æ“‡"});
    // åˆå§‹æ™‚æ¨“/æˆ¶é–å®š
    floorSel.disabled = true; unitSel.disabled = true;
    fill(floorSel, [], {withAll:false, placeholder:"è«‹å…ˆé¸æ£Ÿ"});
    fill(unitSel,  [], {withAll:false, placeholder:"è«‹å…ˆé¸æ¨“"});
  }

  buildingSel.addEventListener("change", ()=>{
    if (!buildingSel.value){
      floorSel.disabled = true; unitSel.disabled = true;
      fill(floorSel, [], {placeholder:"è«‹å…ˆé¸æ£Ÿ"});
      fill(unitSel,  [], {placeholder:"è«‹å…ˆé¸æ¨“"});
      return;
    }
    fill(floorSel, FLOORS, {placeholder:"è«‹é¸æ“‡"});
    floorSel.disabled = false;

    // é‡ç½®æˆ¶åˆ¥
    unitSel.disabled = true;
    fill(unitSel, [], {placeholder:"è«‹å…ˆé¸æ¨“"});
  });

  floorSel.addEventListener("change", ()=>{
    if (!floorSel.value){
      unitSel.disabled = true;
      fill(unitSel, [], {placeholder:"è«‹å…ˆé¸æ¨“"});
      return;
    }
    fill(unitSel, UNITS, {placeholder:"è«‹é¸æ“‡"});
    unitSel.disabled = false;
  });

  // ================== ç¯©é¸ï¼šé€£å‹•ä¸‹æ‹‰ ==================
  function initFilterSelectors(){
    fill(bldF, BUILDINGS, {withAll:true});
    // åˆå§‹ï¼šæ¨“/æˆ¶ç¦ç”¨ï¼Œé¡¯ç¤ºã€Œå…¨éƒ¨ã€
    floorF.disabled = true; unitF.disabled = true;
    fill(floorF, [], {withAll:true});  // åªæœ‰ã€Œå…¨éƒ¨ã€
    fill(unitF,  [], {withAll:true});  // åªæœ‰ã€Œå…¨éƒ¨"}

    bldF.addEventListener("change", ()=>{
      if (!bldF.value){
        // æ²’é¸æ£Ÿï¼æ¨“/æˆ¶å›åˆ°ã€Œå…¨éƒ¨ã€ä¸”ç¦ç”¨
        floorF.disabled = true; unitF.disabled = true;
        fill(floorF, [], {withAll:true});
        fill(unitF,  [], {withAll:true});
        render();
        return;
      }
      // é¸äº†æ£Ÿ â†’ æ¨“å¯é¸
      fill(floorF, FLOORS, {withAll:true});
      floorF.disabled = false;

      // æˆ¶é‡ç½®
      unitF.disabled = true;
      fill(unitF, [], {withAll:true});
      render();
    });

    floorF.addEventListener("change", ()=>{
      if (!floorF.value){
        unitF.disabled = true;
        fill(unitF, [], {withAll:true});
        render();
        return;
      }
      // é¸äº†æ¨“ â†’ æˆ¶å¯é¸
      fill(unitF, UNITS, {withAll:true});
      unitF.disabled = false;
      render();
    });

    unitF.addEventListener("change", render);

    resetFiltersBtn.addEventListener("click", ()=>{
      bldF.value = "";
      floorF.disabled = true; unitF.disabled = true;
      fill(floorF, [], {withAll:true});
      fill(unitF,  [], {withAll:true});
      render();
    });
  }

  function addrMatch(rec, bld, floor, unit){
    // rec.building e.g. ç”²ï¼› rec.floor e.g. 5æ¨“ï¼› rec.unit e.g. ä¹‹2
    if (bld   && rec.building !== bld) return false;
    if (floor && rec.floor    !== floor) return false;
    if (unit  && rec.unit     !== unit) return false;
    return true;
  }

  // ================== è¡¨æ ¼æ¸²æŸ“ ==================
  function render(){
    tableBody.innerHTML = "";
    const b = bldF.value;
    const f = floorF.value;
    const u = unitF.value;

    const rows = records.filter(r => addrMatch(r, b, f, u));
    rows.forEach(r=>{
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${r.time}</td>
        <td>${r.id}</td>
        <td>${r.building}</td>
        <td>${r.floor}</td>
        <td>${r.unit}</td>
        <td>${r.type}</td>
        <td>${r.receiver}</td>
        <td>${r.count}</td>
        <td>${r.company||""}</td>
        <td>${r.note||""}</td>
      `;
      tableBody.appendChild(tr);
    });
    save();
  }

  // ================== æ–°å¢ç´€éŒ„ ==================
  form.addEventListener("submit", e=>{
    e.preventDefault();
    // åŸºæœ¬é©—è­‰
    if (!buildingSel.value || !floorSel.value || !unitSel.value){
      status.textContent = "âš ï¸ ä½å€æœªå®Œæ•´ï¼ˆæ£Ÿ / æ¨“ / æˆ¶ï¼‰";
      status.style.color = "#ef4444";
      return;
    }
    const now = new Date();
    const rec = {
      id: counter++,
      day: todayKey(now),
      time: now.toLocaleString(),
      building: buildingSel.value,
      floor: floorSel.value,
      unit: unitSel.value,
      type: document.getElementById("type").value,
      receiver: document.getElementById("receiver").value.trim(),
      count: parseInt(document.getElementById("count").value||"1",10),
      company: document.getElementById("company").value.trim(),
      note: document.getElementById("note").value.trim()
    };
    records.push(rec);
    render();
    form.reset();
    // é‡ç½®è¡¨å–®ä¸‹æ‹‰ç‹€æ…‹
    initFormSelectors();

    status.textContent = "âœ… å·²æ–°å¢";
    status.style.color = "#16a34a";
    setTimeout(()=> status.textContent="", 1500);
  });

  // ================== åŒ¯å‡º CSV ==================
  function exportCSV(data, filename){
    if (!data.length){ alert("å°šç„¡è³‡æ–™"); return; }
    const header = ["æ™‚é–“","æµæ°´è™Ÿ","æ£Ÿåˆ¥","æ¨“å±¤","æˆ¶è™Ÿ","è²¨ä»¶é¡å‹","æ”¶ä»¶äºº","ä»¶æ•¸","è²¨é‹å…¬å¸","å‚™è¨»"];
    const rows = [header.join(",")];
    const esc = s => `"${String(s??"").replace(/"/g,'""')}"`;
    data.forEach(r=>{
      rows.push([r.time,r.id,r.building,r.floor,r.unit,r.type,r.receiver,r.count,r.company||"",r.note||""].map(esc).join(","));
    });
    const blob = new Blob([rows.join("\n")], {type:"text/csv;charset=utf-8;"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  }

  document.getElementById("exportToday").addEventListener("click", ()=>{
    const today = todayKey();
    exportCSV(records.filter(r=> r.day===today), `SRL_today_${today}.csv`);
  });
  document.getElementById("exportAll").addEventListener("click", ()=>{
    exportCSV(records, "SRL_all.csv");
  });
  document.getElementById("clearAll").addEventListener("click", ()=>{
    if (!confirm("ç¢ºå®šæ¸…é™¤æ‰€æœ‰ç´€éŒ„ï¼Ÿ")) return;
    records = []; counter = 1; save(); render();
  });

  // ================== å•Ÿå‹• ==================
  initFormSelectors();
  initFilterSelectors();
  render();
</script>
</body>
</html>
