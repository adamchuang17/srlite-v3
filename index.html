<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>SimpleReceiveLite v3</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; color:#0f172a }
    h1 { color: #2c3e50; margin-bottom:8px }
    label { display: block; margin-top: 10px; }
    select, input { padding: 6px 8px; margin-top: 5px; width: 220px; }
    button { margin-top: 12px; padding: 8px 14px; border:0; border-radius:6px; background:#22c55e; color:#fff; cursor:pointer }
    button.secondary { background:#0ea5e9 }
    button.warn { background:#ef4444 }
    table { border-collapse: collapse; margin-top: 18px; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size:14px }
    th { background: #f8fafc; }
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .tip{color:#64748b; font-size:12px}
  </style>
</head>
<body>
  <h1>ğŸ“¦ SimpleReceiveLite v3</h1>
  <div class="tip">ï¼ˆå·²å…§å»º CSV åŒ¯å‡ºï¼šä»Šæ—¥ / å…¨éƒ¨ï¼‰</div>

  <form id="receiveForm">
    <label>æ£Ÿåˆ¥ï¼š
      <select id="building" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="47">ç”²æ£Ÿ (47)</option>
        <option value="47-7">ä¹™æ£Ÿ (47-7)</option>
        <option value="47-6">ä¸™æ£Ÿ (47-6)</option>
        <option value="47-5">ä¸æ£Ÿ (47-5)</option>
        <option value="47-3">æˆŠæ£Ÿ (47-3)</option>
        <option value="47-1">å·±æ£Ÿ (47-1)</option>
      </select>
    </label>

    <label>æ¨“å±¤ï¼š
      <select id="floor" required>
        <option value="">è«‹é¸æ“‡</option>
      </select>
    </label>

    <label>æˆ¶è™Ÿï¼š
      <select id="unit" required>
        <option value="">è«‹é¸æ“‡</option>
      </select>
    </label>

    <label>è²¨ä»¶é¡å‹ï¼š
      <select id="type" required>
        <option value="">è«‹é¸æ“‡</option>
        <option value="åŒ…è£¹">åŒ…è£¹</option>
        <option value="æ›è™Ÿ">æ›è™Ÿ</option>
      </select>
    </label>

    <label>æ”¶ä»¶äººï¼š
      <input id="receiver" required placeholder="ä½æˆ¶å§“å" />
    </label>

    <label>ä»¶æ•¸ï¼š
      <input id="count" type="number" min="1" value="1" required />
    </label>

    <label>è²¨é‹å…¬å¸ï¼š
      <input id="company" placeholder="é»‘è²“ / éƒµå±€ / è¶…å•† â€¦" />
    </label>

    <label>å‚™è¨»ï¼š
      <input id="note" placeholder="æ“ºæ”¾ä½ç½®æˆ–å‚™è¨»" />
    </label>

    <button type="submit">æ–°å¢ç´€éŒ„</button>
    <span id="status" class="tip"></span>
  </form>

  <div class="toolbar">
    <button id="exportToday" class="secondary">ä¸‹è¼‰ä»Šæ—¥ç´€éŒ„ (CSV)</button>
    <button id="exportAll" class="secondary">ä¸‹è¼‰å…¨éƒ¨ç´€éŒ„ (CSV)</button>
    <button id="clearAll" class="warn" title="åƒ…æ¸…é™¤æœ¬æ©Ÿä¿å­˜çš„è¡¨æ ¼è³‡æ–™">æ¸…ç©ºç´€éŒ„</button>
  </div>

  <table id="recordTable">
    <thead>
      <tr>
        <th>æ™‚é–“</th>
        <th>æµæ°´è™Ÿ</th>
        <th>æ£Ÿåˆ¥</th>
        <th>æ¨“å±¤</th>
        <th>æˆ¶è™Ÿ</th>
        <th>è²¨ä»¶é¡å‹</th>
        <th>æ”¶ä»¶äºº</th>
        <th>ä»¶æ•¸</th>
        <th>è²¨é‹å…¬å¸</th>
        <th>å‚™è¨»</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    // --------- DOM ----------
    const floorSelect = document.getElementById("floor");
    const unitSelect = document.getElementById("unit");
    const buildingSelect = document.getElementById("building");
    const form = document.getElementById("receiveForm");
    const tbody = document.querySelector("#recordTable tbody");
    const status = document.getElementById("status");
    const btnToday = document.getElementById("exportToday");
    const btnAll = document.getElementById("exportAll");
    const btnClear = document.getElementById("clearAll");

    // --------- Storage ----------
    const KEY = "srlite_v3_records";
    let records = load();

    function load() {
      try { return JSON.parse(localStorage.getItem(KEY) || "[]"); }
      catch { return []; }
    }
    function save() { localStorage.setItem(KEY, JSON.stringify(records)); }

    function nowStr() {
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
    function todayKey(d=new Date()) {
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    }

    // --------- Floors 1~14 ----------
    function loadFloors() {
      floorSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
      for (let i = 1; i <= 14; i++) {
        const opt = document.createElement("option");
        opt.value = i + "æ¨“";
        opt.textContent = i + "æ¨“";
        floorSelect.appendChild(opt);
      }
    }

    // --------- Unitsï¼ˆä¾æ£Ÿåˆ¥è¦å‰‡ï¼‰ ----------
    // è‹¥ä½ è¦çµ±ä¸€ã€Œ1~8 æˆ¶ã€ï¼ŒæŠŠä¸‹æ–¹çš„ switch æ”¹ç‚º 1..8 å³å¯
    function loadUnits(building) {
      unitSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
      // é è¨­ 1~8ï¼ˆç´”æ•¸å­—æˆ¶è™Ÿï¼‰
      let useNumeric = false; // æ”¹æˆ true ï¼é¡¯ç¤º 1~8 æˆ¶ï¼›false ï¼ä¾ç¾æœ‰è¦å‰‡ (ä¹‹X)
      if (useNumeric) {
        for (let i = 1; i <= 8; i++) {
          const opt = document.createElement("option");
          opt.value = i + "æˆ¶";
          opt.textContent = i + "æˆ¶";
          unitSelect.appendChild(opt);
        }
        return;
      }
      // ç¾è¡Œï¼šä¾æ—¢æœ‰è¦å‰‡ï¼ˆä¹‹Xï¼‰
      let maxUnit = 8;
      if (["47", "47-3", "47-5", "47-7"].includes(building)) maxUnit = 2; // ä¹‹1ï½ä¹‹2
      else if (building === "47-6") maxUnit = 7; // ä¹‹1ï½ä¹‹7
      else if (building === "47-1") maxUnit = 8; // ä¹‹1ï½ä¹‹8

      for (let i = 1; i <= maxUnit; i++) {
        const opt = document.createElement("option");
        opt.value = "ä¹‹" + i;
        opt.textContent = "ä¹‹" + i;
        unitSelect.appendChild(opt);
      }
    }

    // äº‹ä»¶ï¼šæ£Ÿåˆ¥æ”¹è®Š â†’ æ¨“å±¤(1~14) & æˆ¶è™Ÿæ›´æ–°
    buildingSelect.addEventListener("change", e => {
      loadFloors();
      if (e.target.value) loadUnits(e.target.value);
      else unitSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
    });

    // åˆå§‹ï¼šè‹¥ä½¿ç”¨è€…é‚„æ²’é¸æ£Ÿåˆ¥ï¼Œå…ˆç©ºç™½
    floorSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
    unitSelect.innerHTML  = '<option value="">è«‹é¸æ“‡</option>';

    // --------- Render table ----------
    function render() {
      tbody.innerHTML = "";
      records.forEach((r, idx) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${r.time}</td>
          <td>${String(idx+1).padStart(4,'0')}</td>
          <td>${r.building}</td>
          <td>${r.floor}</td>
          <td>${r.unit}</td>
          <td>${r.type}</td>
          <td>${r.receiver}</td>
          <td>${r.count}</td>
          <td>${r.company||""}</td>
          <td>${r.note||""}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    render();

    // --------- Submit ----------
    form.addEventListener("submit", e => {
      e.preventDefault();
      const building = buildingSelect.value;
      const floor = floorSelect.value;
      const unit = unitSelect.value;
      const type = document.getElementById("type").value;
      const receiver = document.getElementById("receiver").value.trim();
      const count = parseInt(document.getElementById("count").value || "1", 10);
      const company = document.getElementById("company").value.trim();
      const note = document.getElementById("note").value.trim();

      if (!building || !floor || !unit || !type || !receiver || count < 1) {
        status.textContent = "âš ï¸ è«‹å®Œæ•´å¡«å¯«ï¼ˆæ£Ÿ/æ¨“/æˆ¶/é¡å‹/æ”¶ä»¶äºº/ä»¶æ•¸ï¼‰";
        status.style.color = "#ef4444";
        return;
      }

      const rec = {
        time: nowStr(),
        day: todayKey(),
        building, floor, unit, type, receiver, count, company, note
      };
      records.push(rec);
      save();
      render();
      status.textContent = "âœ… å·²åŠ å…¥";
      status.style.color = "#16a34a";
      form.reset();
      // é‡ç½®ç‚ºæœªé¸ç‹€æ…‹
      floorSelect.innerHTML = '<option value="">è«‹é¸æ“‡</option>';
      unitSelect.innerHTML  = '<option value="">è«‹é¸æ“‡</option>';
    });

    // --------- CSV export ----------
    function toCSV(arr) {
      if (!arr.length) return "";
      const header = Object.keys(arr[0]);
      const esc = s => `"${String(s??"").replace(/"/g,'""')}"`;
      const rows = [header.join(",")];
      arr.forEach(o => rows.push(header.map(k => esc(o[k])).join(",")));
      return rows.join("\n");
    }
    function downloadCSV(rows, filename) {
      const blob = new Blob([rows], {type:"text/csv;charset=utf-8;"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 500);
    }

    btnToday.addEventListener("click", () => {
      const today = todayKey();
      const data = records.filter(r => r.day === today);
      const csv = toCSV(data);
      if (!csv) { alert("ä»Šå¤©å°šç„¡ç´€éŒ„"); return; }
      downloadCSV(csv, `SRL_v3_today_${today}.csv`);
    });

    btnAll.addEventListener("click", () => {
      const csv = toCSV(records);
      if (!csv) { alert("å°šç„¡ç´€éŒ„"); return; }
      downloadCSV(csv, `SRL_v3_all.csv`);
    });

    // --------- Clear (optional) ----------
    btnClear.addEventListener("click", () => {
      if (!confirm("ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬æ©Ÿç´€éŒ„ï¼Ÿ")) return;
      records = [];
      save();
      render();
    });
  </script>
</body>
</html>
