<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>SimpleReceiveLite v3.1</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; color:#0f172a }
    h1 { color: #2c3e50; margin-bottom:8px }
    label { display: block; margin-top: 10px; }
    select, input { padding: 6px 8px; margin-top: 5px; width: 220px; }
    button { margin-top: 12px; padding: 8px 14px; border:0; border-radius:6px; background:#22c55e; color:#fff; cursor:pointer }
    button.secondary { background:#0ea5e9 }
    button.warn { background:#ef4444 }
    table { border-collapse: collapse; margin-top: 18px; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px; text-align: center; font-size:14px }
    th { background: #f8fafc; }
    .toolbar{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .tip{color:#64748b; font-size:12px}
  </style>
</head>
<body>
  <h1>📦 SimpleReceiveLite v3.1</h1>
  <div class="tip">（已內建 待簽收 / 已簽收 / CSV 匯出）</div>

  <!-- 新增紀錄表單 -->
  <form id="receiveForm">
    <label>棟別：
      <select id="building" required>
        <option value="">請選擇</option>
        <option value="47">甲棟 (47)</option>
        <option value="47-7">乙棟 (47-7)</option>
        <option value="47-6">丙棟 (47-6)</option>
        <option value="47-5">丁棟 (47-5)</option>
        <option value="47-3">戊棟 (47-3)</option>
        <option value="47-1">己棟 (47-1)</option>
      </select>
    </label>

    <label>樓層：
      <select id="floor" required></select>
    </label>

    <label>戶號：
      <select id="unit" required></select>
    </label>

    <label>貨件類型：
      <select id="type" required>
        <option value="">請選擇</option>
        <option value="包裹">包裹</option>
        <option value="掛號">掛號</option>
      </select>
    </label>

    <label>收件人：
      <input id="receiver" list="receiverList" placeholder="輸入或選擇" required />
      <datalist id="receiverList"></datalist>
    </label>

    <label>件數：
      <input id="count" type="number" min="1" value="1" required />
    </label>

    <label>貨運公司：
      <input id="company" list="companyList" placeholder="輸入或選擇" />
      <datalist id="companyList"></datalist>
    </label>

    <label>備註：
      <input id="note" placeholder="擺放位置或備註" />
    </label>

    <button type="submit">新增紀錄</button>
    <span id="status" class="tip"></span>
  </form>

  <!-- 工具列 -->
  <div class="toolbar">
    <button id="exportToday" class="secondary">下載今日紀錄</button>
    <button id="exportAll" class="secondary">下載全部紀錄</button>
    <button id="exportPending" class="secondary">下載待簽收</button>
    <button id="exportSigned" class="secondary">下載已簽收</button>
    <button id="clearAll" class="warn">清空所有紀錄</button>
  </div>

  <!-- 待簽收紀錄 -->
  <h3>📋 待簽收紀錄</h3>
  <table id="pendingTable">
    <thead>
      <tr>
        <th>時間</th><th>流水號</th><th>地址</th><th>收件人</th>
        <th>件數</th><th>貨運公司</th><th>備註</th><th>簽收</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <!-- 已簽收紀錄 -->
  <h3>✅ 已簽收紀錄</h3>
  <table id="signedTable">
    <thead>
      <tr>
        <th>時間</th><th>流水號</th><th>地址</th><th>收件人</th>
        <th>件數</th><th>貨運公司</th><th>備註</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const buildingSel = document.getElementById("building");
    const floorSel = document.getElementById("floor");
    const unitSel = document.getElementById("unit");
    const receiverList = document.getElementById("receiverList");
    const companyList = document.getElementById("companyList");
    const pendingBody = document.querySelector("#pendingTable tbody");
    const signedBody = document.querySelector("#signedTable tbody");
    const form = document.getElementById("receiveForm");
    const status = document.getElementById("status");

    // 初始化樓層、戶號
    function initSelectors() {
      floorSel.innerHTML = '<option value="">請選擇</option>';
      for (let i=1;i<=14;i++) floorSel.add(new Option(i+"樓",i+"樓"));
      unitSel.innerHTML = '<option value="">請選擇</option>';
      for (let i=1;i<=8;i++) unitSel.add(new Option("之"+i,"之"+i));
    }
    initSelectors();

    // 紀錄
    let records = JSON.parse(localStorage.getItem("records")||"[]");
    let signed = JSON.parse(localStorage.getItem("signed")||"[]");
    let counter = records.length ? (records[records.length-1].id%500)+1 : 1;

    // 渲染表格
    function renderTables(){
      pendingBody.innerHTML="";
      signedBody.innerHTML="";
      records.forEach(r=>{
        let row=pendingBody.insertRow();
        row.insertCell().textContent=r.time;
        row.insertCell().textContent=r.id;
        row.insertCell().textContent=`${r.building}-${r.floor}-${r.unit}`;
        row.insertCell().textContent=r.receiver;
        row.insertCell().textContent=r.count;
        row.insertCell().textContent=r.company;
        row.insertCell().textContent=r.note;
        let btn=row.insertCell();
        let sbtn=document.createElement("button");
        sbtn.textContent="簽收";
        sbtn.onclick=()=>{signRecord(r.id)};
        btn.appendChild(sbtn);
      });
      signed.forEach(r=>{
        let row=signedBody.insertRow();
        row.insertCell().textContent=r.time;
        row.insertCell().textContent=r.id;
        row.insertCell().textContent=`${r.building}-${r.floor}-${r.unit}`;
        row.insertCell().textContent=r.receiver;
        row.insertCell().textContent=r.count;
        row.insertCell().textContent=r.company;
        row.insertCell().textContent=r.note;
      });
      localStorage.setItem("records",JSON.stringify(records));
      localStorage.setItem("signed",JSON.stringify(signed));
    }

    // 簽收
    function signRecord(id){
      let idx=records.findIndex(r=>r.id===id);
      if(idx>-1){
        signed.push(records[idx]);
        records.splice(idx,1);
        renderTables();
      }
    }

    // 新增紀錄
    form.onsubmit=(e)=>{
      e.preventDefault();
      const rec={
        id:counter,
        time:new Date().toLocaleString(),
        building:buildingSel.value,
        floor:floorSel.value,
        unit:unitSel.value,
        receiver:document.getElementById("receiver").value,
        count:document.getElementById("count").value,
        company:document.getElementById("company").value,
        note:document.getElementById("note").value
      };
      counter = counter===500?1:counter+1;
      records.push(rec);
      addToList(receiverList,rec.receiver);
      addToList(companyList,rec.company);
      renderTables();
      form.reset();
      status.textContent="✅ 已新增";
      setTimeout(()=>status.textContent="",1500);
    };

    function addToList(datalist,value){
      if(value && ![...datalist.options].some(o=>o.value===value)){
        let opt=document.createElement("option");
        opt.value=value; datalist.appendChild(opt);
      }
    }

    // 匯出 CSV
    function exportCSV(data,name){
      let csv="時間,流水號,地址,收件人,件數,貨運公司,備註\n";
      data.forEach(r=>{
        csv+=[r.time,r.id,`${r.building}-${r.floor}-${r.unit}`,r.receiver,r.count,r.company,r.note].join(",")+"\n";
      });
      let blob=new Blob([csv],{type:"text/csv"});
      let a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=name; a.click();
    }

    document.getElementById("exportToday").onclick=()=>exportCSV(records.filter(r=>r.time.startsWith(new Date().toLocaleDateString())),"today.csv");
    document.getElementById("exportAll").onclick=()=>exportCSV(records.concat(signed),"all.csv");
    document.getElementById("exportPending").onclick=()=>exportCSV(records,"pending.csv");
    document.getElementById("exportSigned").onclick=()=>exportCSV(signed,"signed.csv");
    document.getElementById("clearAll").onclick=()=>{ if(confirm("確定清除所有紀錄？")){records=[];signed=[];counter=1;renderTables();} };

    renderTables();
  </script>
</body>
</html>
