<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>SimpleReceiveLite v3 â€” å¾…ç°½æ”¶ / å·²ç°½æ”¶</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f172a;--panel:#0b1220;--card:#111827;--muted:#64748b;--text:#e5e7eb;--accent:#22c55e;--danger:#ef4444;--info:#0ea5e9}
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,"PingFang TC","Microsoft JhengHei",sans-serif}
    .wrap{max-width:1100px;margin:24px auto;padding:16px}
    h1{margin:0 0 8px}
    .sub{color:#94a3b8;font-size:13px;margin-bottom:12px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border-radius:999px;border:1px solid #334155;background:#0b1220;color:#cbd5e1;cursor:pointer}
    .tab.active{background:var(--accent);color:#052e12;border-color:#16a34a}
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    label{display:block;font-size:13px;color:#a1a1aa;margin:6px 0}
    input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1220;color:#e5e7eb}
    .grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .grid2{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{padding:8px 12px;border:0;border-radius:10px;background:#334155;color:#fff;cursor:pointer}
    .primary{background:var(--accent);color:#052e12;font-weight:700}
    .danger{background:var(--danger)}
    .info{background:var(--info)}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border-bottom:1px solid #243244;text-align:left;font-size:13px}
    th{color:#cbd5e1}
    .toolbar{display:flex;gap:8px;justify-content:space-between;align-items:center;margin:6px 0 10px}
    .pill{font-size:12px;color:#94a3b8}
    .hint{color:#86efac;font-size:12px;margin-top:6px}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modal.show{display:flex}
    .box{background:#111827;border-radius:14px;padding:14px;max-width:900px;width:100%}
    canvas{width:100%;height:220px;background:#0b1220;border:1px dashed #334155;border-radius:10px;touch-action:none}
  </style>
</head>
<body>
<div class="wrap">
  <h1>ğŸ“¦ SimpleReceiveLite v3</h1>
  <div class="sub">æµç¨‹ï¼šæ–°å¢ â†’ <b>ä¾ä½å€æœå°‹</b> â†’ <b>ç°½æ”¶</b> â†’ ç§»å…¥ã€Œå·²ç°½æ”¶ã€ã€‚è³‡æ–™å­˜æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ï¼Œå…©é‚Šçš†å¯åŒ¯å‡º CSVã€‚</div>

  <div class="tabs">
    <button class="tab active" data-tab="add">â• æ–°å¢</button>
    <button class="tab" data-tab="pending">ğŸ“¥ å¾…ç°½æ”¶</button>
    <button class="tab" data-tab="signed">ğŸ“¤ å·²ç°½æ”¶</button>
  </div>

  <!-- æ–°å¢ -->
  <section id="tab-add" class="card">
    <div class="grid">
      <div><label>æ£Ÿåˆ¥</label><select id="bld"></select></div>
      <div><label>æ¨“å±¤</label><select id="floor"></select></div>
      <div><label>æˆ¶åˆ¥</label><select id="unit"></select></div>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div><label>æ”¶ä»¶äºº</label><input id="receiver" placeholder="ä½æˆ¶å§“å" /></div>
      <div><label>ä»¶åˆ¥</label>
        <select id="category"><option>åŒ…è£¹</option><option>æ›è™Ÿ</option></select>
      </div>
      <div><label>è²¨é‹å…¬å¸</label>
        <input id="company" list="companyList" placeholder="å¤§æ¦® / æ–°ç«¹ / å®…é…é€š / å®…æ€¥ä¾¿ / å…¶ä»–" />
        <datalist id="companyList">
          <option value="å¤§æ¦®"><option value="æ–°ç«¹"><option value="å®…é…é€š"><option value="å®…æ€¥ä¾¿"><option value="å…¶ä»–">
        </datalist>
      </div>
      <div><label>ä»¶æ•¸</label><input id="qty" type="number" min="1" value="1" /></div>
      <div style="grid-column:1/-1"><label>å‚™è¨»</label><input id="note" placeholder="æ“ºæ”¾ä½ç½®æˆ–å‚™è¨»" /></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="addBtn">åŠ å…¥å¾…ç°½æ”¶</button>
      <span class="pill" id="pendingCount">0 å¾…ç°½æ”¶</span>
    </div>
    <div class="hint">æ–°å¢å®Œæˆæœƒè‡ªå‹•è·³åˆ°ã€Œå¾…ç°½æ”¶ã€ï¼Œå¯ç›´æ¥ç”¨ä¸Šæ–¹æœå°‹ä½å€ã€‚</div>
  </section>

  <div style="height:10px"></div>

  <!-- å¾…ç°½æ”¶ -->
  <section id="tab-pending" class="card" style="display:none">
    <div class="toolbar">
      <input id="qPending" placeholder="æœå°‹ï¼šä½å€ï¼ˆç”²/ä¹™/ä¸™/ä¸/æˆŠ/å·± + æ¨“ + æˆ¶ï¼‰/ æ”¶ä»¶äºº / è²¨é‹ / ä»¶åˆ¥" style="flex:1" />
      <div class="row">
        <button class="btn info" id="exportPending">åŒ¯å‡ºCSVï¼ˆå¾…ç°½æ”¶ï¼‰</button>
        <span class="pill" id="pendingCount2">0 ç­†</span>
      </div>
    </div>
    <table>
      <thead><tr><th>#</th><th>æ™‚é–“</th><th>ä½å€</th><th>ä»¶åˆ¥</th><th>æ”¶ä»¶äºº</th><th>è²¨é‹</th><th>ä»¶æ•¸</th><th>å‚™è¨»</th><th>å‹•ä½œ</th></tr></thead>
      <tbody id="tbPending"></tbody>
    </table>
  </section>

  <div style="height:10px"></div>

  <!-- å·²ç°½æ”¶ -->
  <section id="tab-signed" class="card" style="display:none">
    <div class="toolbar">
      <input id="qSigned" placeholder="æœå°‹ï¼šä½å€ / æ”¶ä»¶äºº / è²¨é‹ / ç°½æ”¶äºº / ä»¶åˆ¥" style="flex:1" />
      <div class="row">
        <button class="btn info" id="exportSigned">åŒ¯å‡ºCSVï¼ˆå·²ç°½æ”¶ï¼‰</button>
        <span class="pill" id="signedCount">0 ç­†</span>
      </div>
    </div>
    <table>
      <thead><tr><th>#</th><th>æ”¶è²¨æ™‚é–“</th><th>ä½å€</th><th>ä»¶åˆ¥</th><th>æ”¶ä»¶äºº</th><th>è²¨é‹</th><th>ä»¶æ•¸</th><th>å‚™è¨»</th><th>ç°½æ”¶äºº</th><th>ç°½æ”¶æ™‚é–“</th><th>ç°½å</th><th>å‹•ä½œ</th></tr></thead>
      <tbody id="tbSigned"></tbody>
    </table>
  </section>
</div>

<!-- ç°½æ”¶è¦–çª— -->
<div class="modal" id="signModal">
  <div class="box">
    <h3 style="margin:0 0 8px">ç°½æ”¶</h3>
    <div class="grid2">
      <div><label>ç°½æ”¶äºº</label><input id="signer" placeholder="ä½æˆ¶ç°½æ”¶äºº" /></div>
      <div><label>ä»¶æ•¸ç¢ºèª</label><input id="signQty" type="number" min="1" /></div>
    </div>
    <label style="margin-top:8px">ç°½å</label>
    <canvas id="sig" width="880" height="220"></canvas>
    <div class="row" style="margin-top:8px;justify-content:flex-end">
      <button class="btn" id="clearSig">æ¸…é™¤</button>
      <button class="btn danger" id="cancelSign">å–æ¶ˆ</button>
      <button class="btn primary" id="confirmSign">ç¢ºèªç°½æ”¶ â†’ è½‰å…¥å·²ç°½æ”¶</button>
    </div>
  </div>
</div>

<script>
(()=>{
// ====== å·¥å…· ======
const $=id=>document.getElementById(id);
const pad=n=>String(n).padStart(2,'0');
const nowISO=()=>{const d=new Date();return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`};
const load=(k,f)=>{try{return JSON.parse(localStorage.getItem(k)||JSON.stringify(f));}catch(_){return f;}};
const save=(k,v)=> localStorage.setItem(k, JSON.stringify(v));
const esc=s=>String(s||"").replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));

// ====== è³‡æ–™éµ ======
const PENDING='srl_v3_pending';
const SIGNED='srl_v3_signed';

// ====== åœ°å€ä¸‹æ‹‰ï¼šç”²/ä¹™/ä¸™/ä¸/æˆŠ/å·± Ã— 1â€“14 æ¨“ Ã— ä¹‹1~ä¹‹8 ======
const BUILDINGS=["ç”²","ä¹™","ä¸™","ä¸","æˆŠ","å·±"];
const FLOORS=Array.from({length:14},(_,i)=> i+1);
const UNITS = Array.from({length:8},(_,i)=> `ä¹‹${i+1}`);

function fill(sel, arr, fmt=(x)=>x){
  sel.innerHTML='';
  arr.forEach(v=>{const o=document.createElement('option'); o.value=v; o.textContent=fmt(v); sel.appendChild(o);});
}
function initSelectors(){
  fill($('bld'), BUILDINGS);
  fill($('floor'), FLOORS, f=> `${f}æ¨“`);
  fill($('unit'), UNITS);
}
function fullAddress(){ return `${$('bld').value} ${$('floor').value}æ¨“${$('unit').value}`; }
initSelectors();

// ====== æ–°å¢ â†’ å¾…ç°½æ”¶ ======
$('addBtn').onclick=()=>{
  const receiver=$('receiver').value.trim();
  if(!receiver) return alert('è«‹å¡«æ”¶ä»¶äºº');
  const list=load(PENDING,[]);
  list.push({
    id: (crypto&&crypto.randomUUID? crypto.randomUUID(): String(Date.now())),
    created_at: nowISO(),
    address: fullAddress(),
    category: $('category').value,
    receiver,
    company: $('company').value.trim(),
    qty: parseInt(($('qty').value||'1'),10),
    note: $('note').value.trim()
  });
  save(PENDING, list);
  $('receiver').value=''; $('company').value=''; $('qty').value=1; $('note').value='';
  renderPending(); switchTab('pending');
};

// ====== å¾…ç°½æ”¶è¡¨ + æœå°‹ ======
const qPending=$('qPending'), tbPending=$('tbPending');
function renderPending(){
  const list=load(PENDING,[]);
  const q=(qPending.value||'').trim().toLowerCase();
  const rows=list.filter(r=> !q || [r.address,r.receiver,r.company,r.category].join(' ').toLowerCase().includes(q));
  tbPending.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.created_at}</td><td>${esc(r.address)}</td><td>${esc(r.category)}</td><td>${esc(r.receiver)}</td><td>${esc(r.company)}</td><td>${r.qty}</td><td>${esc(r.note)}</td>
    <td>
      <button class="btn primary" data-act="sign" data-id="${r.id}">ç°½æ”¶</button>
      <button class="btn danger" data-act="del" data-id="${r.id}">åˆªé™¤</button>
    </td>`;
    tbPending.appendChild(tr);
  });
  $('pendingCount').textContent = `${list.length} å¾…ç°½æ”¶`;
  $('pendingCount2').textContent = `${rows.length} ç­†`;
}
qPending.addEventListener('input', renderPending);
tbPending.addEventListener('click', e=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.getAttribute('data-id');
  const list=load(PENDING,[]); const idx=list.findIndex(x=>x.id===id);
  if(btn.dataset.act==='del' && idx>-1){
    if(confirm('åˆªé™¤æ­¤å¾…ç°½æ”¶ï¼Ÿ')){ list.splice(idx,1); save(PENDING,list); renderPending(); }
  }else if(btn.dataset.act==='sign' && idx>-1){
    openSign(id, list[idx].qty);
  }
});
$('exportPending').onclick=()=> exportCSV(load(PENDING,[]), 'pending.csv');

// ====== å·²ç°½æ”¶è¡¨ + æœå°‹ ======
const qSigned=$('qSigned'), tbSigned=$('tbSigned');
function renderSigned(){
  const list=load(SIGNED,[]);
  const q=(qSigned.value||'').trim().toLowerCase();
  const rows=list.filter(r=> !q || [r.address,r.receiver,r.company,r.category,r.signer].join(' ').toLowerCase().includes(q));
  tbSigned.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${r.created_at}</td><td>${esc(r.address)}</td><td>${esc(r.category)}</td><td>${esc(r.receiver)}</td><td>${esc(r.company)}</td><td>${r.qty}</td><td>${esc(r.note)}</td><td>${esc(r.signer||'')}</td><td>${r.signed_at||''}</td>
    <td>`+(r.signature?`<a class="btn" href="${r.signature}" download="signature_${r.id}.png">ä¸‹è¼‰</a>`:'â€”')+`</td>
    <td><button class="btn danger" data-del="${r.id}">åˆªé™¤</button></td>`;
    tbSigned.appendChild(tr);
  });
  $('signedCount').textContent = `${rows.length} ç­†`;
}
qSigned.addEventListener('input', renderSigned);
tbSigned.addEventListener('click', e=>{
  const id=e.target.getAttribute('data-del'); if(!id) return;
  const list=load(SIGNED,[]); const idx=list.findIndex(x=>x.id===id);
  if(idx>-1 && confirm('åˆªé™¤æ­¤å·²ç°½æ”¶ï¼Ÿ')){ list.splice(idx,1); save(SIGNED,list); renderSigned(); }
});
$('exportSigned').onclick=()=> exportCSV(load(SIGNED,[]), 'signed.csv');

// ====== åŒ¯å‡º CSV ======
function exportCSV(arr, filename){
  const header = Object.keys(arr[0]||{id:'',created_at:'',address:'',category:'',receiver:'',company:'',qty:'',note:'',signer:'',signed_at:'',signature:''});
  const rows=[header.join(',')];
  const escq = s=> `"${String(s??"").replace(/"/g,'""')}"`;
  arr.forEach(o=> rows.push(header.map(k=> escq(o[k])).join(',')));
  const blob=new Blob([rows.join('\n')],{type:'text/csv;charset=utf-8;'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),800);
}

// ====== åˆ†é åˆ‡æ› ======
const tabs=[...document.querySelectorAll('.tab')];
function switchTab(name){
  tabs.forEach(t=> t.classList.toggle('active', t.dataset.tab===name));
  ['add','pending','signed'].forEach(n=> document.getElementById('tab-'+n).style.display=(n===name?'block':'none'));
  if(name==='pending') renderPending();
  if(name==='signed') renderSigned();
}
tabs.forEach(t=> t.addEventListener('click', ()=> switchTab(t.dataset.tab)));
renderPending(); renderSigned();

// ====== ç°½å / ç°½æ”¶ â†’ è½‰å·²ç°½æ”¶ ======
const modal=$('signModal'), signerEl=$('signer'), signQtyEl=$('signQty'), sig=$('sig'), ctx=sig.getContext('2d');
let drawing=false,last=null,currentId=null;

function resetCanvas(){ ctx.fillStyle="#0b1220"; ctx.fillRect(0,0,sig.width,sig.height); ctx.strokeStyle="#e5e7eb"; ctx.lineWidth=3; ctx.lineCap='round'; }
resetCanvas();
function pos(e){ const r=sig.getBoundingClientRect(); const x=(e.touches?e.touches[0].clientX:e.clientX)-r.left; const y=(e.touches?e.touches[0].clientY:e.clientY)-r.top; return {x:x*(sig.width/r.width), y:y*(sig.height/r.height)}; }
function start(e){ drawing=true; last=pos(e); e.preventDefault(); }
function move(e){ if(!drawing) return; const p=pos(e); ctx.beginPath(); ctx.moveTo(last.x,last.y); ctx.lineTo(p.x,p.y); ctx.stroke(); last=p; e.preventDefault(); }
function end(){ drawing=false; last=null }
sig.addEventListener('mousedown',start); sig.addEventListener('mousemove',move); window.addEventListener('mouseup',end);
sig.addEventListener('touchstart',start,{passive:false}); sig.addEventListener('touchmove',move,{passive:false}); sig.addEventListener('touchend',end);
$('clearSig').onclick=resetCanvas;
$('cancelSign').onclick=()=> modal.classList.remove('show');

function openSign(id, qty){
  currentId=id; signerEl.value=''; signQtyEl.value=qty||1; resetCanvas(); modal.classList.add('show');
}
$('confirmSign').onclick=()=>{
  const signer=signerEl.value.trim(); if(!signer) return alert('è«‹å¡«ç°½æ”¶äºº');
  const pend=load(PENDING,[]); const idx=pend.findIndex(x=>x.id===currentId); if(idx===-1) return;
  const item=pend[idx];
  // å¾å¾…ç°½æ”¶ç§»é™¤
  pend.splice(idx,1); save(PENDING, pend);
  // å­˜å…¥å·²ç°½æ”¶
  const signed=load(SIGNED,[]);
  signed.push({...item, signer, signed_at: nowISO(), qty: parseInt(signQtyEl.value||item.qty,10), signature: sig.toDataURL('image/png')});
  save(SIGNED, signed);
  modal.classList.remove('show'); renderPending(); renderSigned(); switchTab('signed');
};

// è®“ã€Œç°½æ”¶ã€æŒ‰éˆ•å¯ä»¥å«å‡ºè¦–çª—
window.openSign=openSign;
})();
</script>
</body>
</html>
